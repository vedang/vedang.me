<html><head><meta charset="UTF-8" content="My corner on the Internet." /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/atom.xml" rel="alternate" title="Vedang Manerikar" type="application/atom+xml" /><link href="/style.css" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" type="application/javascript"></script><script crossorigin="anonymous" integrity="sha512-BrJeu0wD2TAYh1Vb3N0BSn/7t43FfeEkDNof6XUX5wFLmFb1z3tS/8bbr1XZqDg96KjtfmuSyI0AUCayDMQYNw==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clojure.min.js" type="application/javascript"></script><link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" integrity="sha512-vswe+cgvic/XBoF1OcM/TeJ2FW0OofqAVdCZiEYkd6dwGXthvkSFWOoGGJgS2CW70VK5dQM5Oh+7ne47s74VTg==" referrerpolicy="no-referrer" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" integrity="sha512-st608h+ZqzliahyzEpETxzU0f7z7a9acN6AFvYmHvpFhmcFuKT8a22TT5TpKpjDa3pt3Wv7Z3SdQBCBdDPhyWA==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js" type="application/javascript"></script><link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" integrity="sha512-Dqf5696xtofgH089BgZJo2lSWTvev4GFo+gA2o4GullFY65rzQVQLQVlzLvYwTo0Bb2Gpb6IqwxYWtoMonfdhQ==" referrerpolicy="no-referrer" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" integrity="sha512-/kVH1uXuObC0iYgxxCKY41JdWOkKOxorFVmip+YVifKsJ4Au/87EisD1wty7vxN2kAhnWh6Yc8o/dSAXj6Oz7A==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js" type="application/javascript"></script><title>Composability and Compojure</title><link href="static/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="static/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="static/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="static/site.webmanifest" rel="manifest" /><link color="#5bbad5" href="static/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#da532c" name="msapplication-TileColor" /><meta content="#ffffff" name="theme-color" /></head><body><div class="m-2 border-b-2 border-gray-300" id="site-header"><div class="prose prose-stone dark:prose-inverted mx-auto grid grid-cols-2" id="site-title"><div><h1 class="m-0 lg:text-2xl"><a href="/index.html">Vedang Manerikar</a></h1><p class="font-semi-bold mt-1 text-lg text-gray-800">My corner on the Internet.</p></div><div><nav id="site-nav"><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="/atom.xml">Feed</a><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="https://twitter.com/vedang" target="_blank">Twitter</a><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="https://fosstodon.org/@vedang" target="_blank">Mastodon</a><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="/about.html">About</a></nav></div></div></div><div class="prose prose-stone dark:prose-invert xl:max-w-6xl mx-auto prose-ul:list-none prose-img:rounded-xl prose-img:shadow-xl" id="post-container"><div id="post-body"><p><div class="ox-neuron-main"> <div class="ox-neuron-article"> <h1 class="ox-neuron-article-heading">Composability and Compojure</h1> <div class="ox-neuron-article-contents"> <i>Caveat</i>: This post needs some rudimentary knowledge of Compojure. Compojure is a web framework for Clojure, and if you don't understand what that means, then you should probably head over to the <a href='https://github.com/weavejester/compojure/wiki'>Compojure docs</a>.</p><p>Compojure exposes us to a beautifully <span class="underline">composable</span> abstraction, and this post is an attempt to show why that is a great thing.</p><p><!&ndash;more&ndash;></p><p>In order to understand the Compojure framework, let us write a small <code>cello world</code> app. The code snippets in this post are a means to explain a concept, they may not work as-is. The full, working code is available at <a href='https://gist.github.com/1893532/'>this</a> gist. Okay then, let's get started.</p><p>Here is what the basic routes function would look like:</p><pre><code class="lang-clojure">&#40;cc/defroutes main-routes
  &#40;cc/GET &quot;/&quot; &#91;&#93; &#40;fn &#91;req&#93;
                   &#40;rur/response &quot;&lt;h1&gt;Cello World&lt;/h1&gt;&quot;&#41;&#41;&#41;
  &#40;cc/GET &quot;/bye/&quot; &#91;&#93; &#40;fn &#91;req&#93;
                       &#40;rur/response &quot;&lt;h1&gt;Goodbye World&lt;/h1&gt;&quot;&#41;&#41;&#41;
  &#40;route/not-found &quot;&lt;h1&gt;Page not found&lt;/h1&gt;&quot;&#41;&#41;
</code></pre><p>Compojure uses Ring to handle requests and responses. These terms (request/response) don't mean 'objects' (to those of you from the OOP world) of any kind, they are just hash-maps used to <span class="underline">represent</span> the idea. They are data, and as such, can be manipulated in any way we want. Ring has a simple philosophy: write functions which accept a request and return a response. Such functions are called <span class="underline">handlers</span>.</p><p>The <code>cc/GET</code> helper macro - and it's ilk - asks the user for a request-method (specified by the GET in the name <code>cc/GET</code>), a route (string representing uri), and a handler(H1). The macro becomes a handler (H2) which returns the result of <code>&#40;H1 req&#41;</code> if the route and the method of the incoming request match the specified route and request-method, otherwise it returns nil. This is our first introduction to composability in Compojure. We have a macro that takes a handler and gives us another handler. As long as we are dealing in handlers, composability allows us to ignore any implementation complexity.</p><p>The <code>cc/defroutes</code> macro takes a name and a list of handlers and returns a handler (H3) which runs all the handlers in the list on the request until one of them returns a non-nil value, else it returns nil. Finally, it binds the name to the handler so that we can call it. Simple, isn't it?</p><p>So if you think you've understood it so far, tell me if adding this route to our main routes will work or not:</p><pre><code class="lang-clojure">&#40;cc/GET &quot;/hello&#42;&quot; &#91;&#93; &#40;cc/defroutes hello-routes
                       &#40;cc/GET &quot;/hello/name/&quot; &#91;&#93;
                               &#40;fn &#91;req&#93;
                                 &#40;rur/response &quot;&lt;h1&gt;Cello Vedang&lt;/h1&gt;&quot;&#41;&#41;&#41;
                       &#40;cc/GET &quot;/hello/city/&quot; &#91;&#93;
                               &#40;fn &#91;req&#93;
                                 &#40;rur/response &quot;&lt;h1&gt;Cello from Pune!&lt;/h1&gt;&quot;&#41;&#41;&#41;&#41;&#41;
</code></pre><p>Well, yes! <code>cc/defroutes</code> gives us a handler<a href='#fn-1' id='fnref1'><sup>1</sup></a>, and that's really all <code>cc/GET</code> cares about!</p><p>Having an abstraction of this form allows us to do many things easily, knowing that stuff <span class="underline">just works</span>. For example, let us write some <span class="underline">middleware</span>. What is middleware? Middleware modifies the incoming request or outgoing response in some way that makes us happy. How does this fit into our abstraction? - As a function that takes a handler(H1) and, wait for it, returns another handler(H2). Boom! Confused? Here is what a middleware function looks like:</p><pre><code class="lang-clojure">&#40;defn verify-secret
  &quot;Verify that secret-key has been sent as a parameter s in the request&quot;
  &#91;handler&#93;
  &#40;fn &#91;request&#93;
    &#40;if &#40;= &quot;s=please&quot; &#40;:query-string request&#41;&#41;
      &#40;handler request&#41;
      {:status 403
       :body &quot;You don't know the secret word&quot;}&#41;&#41;&#41;
</code></pre><p>This function gets a handler(H1). It doesn't know or care what that handler is going to do to the request. It returns a new handler(H2) which does the following: it checks to see if the incoming request knows that the secret word s is "please". If it does, great. Execute H1 on the request and call it a day. Otherwise, return a nil - meaning the request in not valid. Now H2 could go through as many other middleware functions as we want, all of them agnostic of any other middleware functions. Each middleware will return a modified handler(H3, H4, ... Hn), and we will run the final handler on the request.</p><p>Here is what the final code would look like:</p><pre><code class="lang-clojure">;; Define some Hello routes
&#40;cc/defroutes hello-routes
  &#40;cc/GET &quot;/hello/name/&quot; &#91;&#93;
          &#40;fn &#91;req&#93;
            &#40;rur/response &quot;&lt;h1&gt;Cello Vedang&lt;/h1&gt;&quot;&#41;&#41;&#41;
  &#40;cc/GET &quot;/hello/city/&quot; &#91;&#93;
          &#40;fn &#91;req&#93;
            &#40;rur/response &quot;&lt;h1&gt;Cello from Pune!&lt;/h1&gt;&quot;&#41;&#41;&#41;&#41;

;; Our main routes function.
&#40;cc/defroutes main-routes&#42;
  &#40;cc/GET &quot;/&quot; &#91;&#93; &#40;fn &#91;req&#93;
                   &#40;rur/response &quot;&lt;h1&gt;Cello World&lt;/h1&gt;&quot;&#41;&#41;&#41;
  &#40;cc/GET &quot;/bye/&quot; &#91;&#93; &#40;fn &#91;req&#93;
                       &#40;rur/response &quot;&lt;h1&gt;Goodbye World&lt;/h1&gt;&quot;&#41;&#41;&#41;
  &#40;cc/GET &quot;/hello&#42;&quot; &#91;&#93; hello-routes&#41;
  &#40;route/not-found &quot;&lt;h1&gt;Page not found&lt;/h1&gt;&quot;&#41;&#41;

;; A middleware function
&#40;defn verify-secret
  &quot;Verify that secret-key has been sent as a parameter s in the request&quot;
  &#91;handler&#93;
  &#40;fn &#91;request&#93;
    &#40;if &#40;= &quot;s=please&quot; &#40;:query-string request&#41;&#41;
      &#40;handler request&#41;
      {:status 403
       :body &quot;You don't know the secret word&quot;}&#41;&#41;&#41;

;;; Wrap my main routes in middleware
&#40;def main-routes &#40;-&gt; #'main-routes&#42;
                     verify-secret&#41;&#41;

;;; Start app with main routes
&#40;run-jetty #'main-routes {:port port :join? false}&#41;
</code></pre><p><code>main-routes&#42;</code> is a handler which matches the incoming uris to ones we support, <code>verify-secret</code> will make sure that the incoming requests know the secret word. We can go a really long way with functions that take a request and return a response. Compojure gives us a great DSL to deal with the web. It's composability facilitates building elegant systems and frameworks.</p><h2 id="footnotes">Footnotes:</h2><p></div> </div> <div class="ox-neuron-footnotes"> <div class="ox-neuron-footnotes-contents"></p></div></div></div><ol class='footnotes'><li id='fn-1'>: Actually, we got lucky in this case. <code>cc/defroutes</code> is a macro. When we say <code>&#40;cc/defroutes name &amp; handlers&#41;</code> the code is replaced to become <code>&#40;def name handlerfn&#41;</code>. Luckily for us though, def returns the variable which was just defined, and it works out okay in the end. The aim was to show composability in action, not to espouse a coding style. Never do this in actual code.<a href='#fnref1'>&#8617;</a></li></ol></div><div id="post-last-updated"><p><i>Last Updated: 2012-02-23T23:58:00Z</i></p></div><hr /><div id="post-parents"><div id="post-links"><h1>Parents</h1><ul><li><span>2023-05-24</span><span> - </span><a href="/programming.html">Programming</a></li></ul></div></div><hr /><div id="post-tags"><h1 class="links-header">Tags</h1><div class="flex"><div class="inline-flex"><a href="/tags/ring.html">ring</a><span class="mx-2">|</span></div><div class="inline-flex"><a href="/tags/clojure.html">clojure</a><span class="mx-2">|</span></div><div class="inline-flex"><a href="/tags/programming.html">programming</a><span class="mx-2">|</span></div><div class="inline-flex"><a href="/tags/compojure.html">compojure</a><span class="mx-2"></span></div></div></div><nav class="bottom-0 right-0 float-right mb-6" id="post-nav"><a class="px-2" href="/index.html">Archive</a><a class="px-2" href="https://github.com/vedang/vedang.me/blob/master/components/content/resources/content/programming/composability-and-compojure.md" target="_blank">Discuss this post</a></nav><nav class="bottom-0 left-0 float-left mb-6" id="copyright-nav"><p>Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International license</a>.</p><p>Built with ❤️, using <a href="https://www.gnu.org/software/emacs/">Emacs</a>, <a href="https://orgmode.org/">Org-mode</a>, <a href="https://clojure.org/index">Clojure</a>, <a href="https://babashka.org/">Babashka</a>, <a href="https://tailwindcss.com/">TailwindCSS</a>, <a href="https://prismjs.com/">PrismJS</a></p></nav></div></body></html>