<html><head><meta charset="UTF-8" content="My corner on the Internet." /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/atom.xml" rel="alternate" title="Vedang Manerikar" type="application/atom+xml" /><link href="/style.css" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" type="application/javascript"></script><script crossorigin="anonymous" integrity="sha512-BrJeu0wD2TAYh1Vb3N0BSn/7t43FfeEkDNof6XUX5wFLmFb1z3tS/8bbr1XZqDg96KjtfmuSyI0AUCayDMQYNw==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clojure.min.js" type="application/javascript"></script><link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" integrity="sha512-vswe+cgvic/XBoF1OcM/TeJ2FW0OofqAVdCZiEYkd6dwGXthvkSFWOoGGJgS2CW70VK5dQM5Oh+7ne47s74VTg==" referrerpolicy="no-referrer" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" integrity="sha512-st608h+ZqzliahyzEpETxzU0f7z7a9acN6AFvYmHvpFhmcFuKT8a22TT5TpKpjDa3pt3Wv7Z3SdQBCBdDPhyWA==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js" type="application/javascript"></script><link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" integrity="sha512-Dqf5696xtofgH089BgZJo2lSWTvev4GFo+gA2o4GullFY65rzQVQLQVlzLvYwTo0Bb2Gpb6IqwxYWtoMonfdhQ==" referrerpolicy="no-referrer" rel="stylesheet" type="text/css" /><script crossorigin="anonymous" integrity="sha512-/kVH1uXuObC0iYgxxCKY41JdWOkKOxorFVmip+YVifKsJ4Au/87EisD1wty7vxN2kAhnWh6Yc8o/dSAXj6Oz7A==" referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js" type="application/javascript"></script><title>Gitlab Private Pages + Running Docker containers in Gitlab CI/CD Pipelines</title><link href="static/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="static/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="static/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="static/site.webmanifest" rel="manifest" /><link color="#5bbad5" href="static/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#da532c" name="msapplication-TileColor" /><meta content="#ffffff" name="theme-color" /></head><body><div class="m-2 border-b-2 border-gray-300" id="site-header"><div class="prose prose-stone dark:prose-inverted mx-auto grid grid-cols-2" id="site-title"><div><h1 class="m-0 text-base sm:text-lg md:text-xl lg:text-2xl"><a href="/index.html">Vedang Manerikar</a></h1><p class="font-semi-bold mt-1 text-gray-800 xl:text-lg">My corner on the Internet.</p></div><div><nav class="overflow-auto lg:overflow-hidden" id="site-nav"><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="/atom.xml">Feed</a><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="https://twitter.com/vedang" target="_blank">Twitter</a><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="https://fosstodon.org/@vedang" target="_blank">Mastodon</a><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="/about.html">About</a><a class="p-2 font-medium text-gray-700 transition duration-200 hover:bg-gray-100 hover:text-gray-900 hover:ease-in-out" href="/now.html">Now</a></nav></div></div></div><div class="prose prose-stone dark:prose-invert max-w-prose xl:max-w-6xl mx-auto prose-ul:list-none prose-img:rounded-xl prose-img:shadow-xl" id="post-container"><div id="post-body"><p><div class="ox-neuron-main"> <div class="ox-neuron-article"> <h1 class="ox-neuron-article-heading">Gitlab Private Pages + Running Docker containers in Gitlab CI/CD Pipelines</h1> <div class="ox-neuron-article-contents"></p><h2 id="private-pages-on-gitlab">Private pages on Gitlab</h2><p>Did you know that <a href='https://docs.gitlab.com/ee/user/project/pages/'>Gitlab Pages</a> supports private / auth-based static sites? Basically, you add people you want to share your site with as Project Members to the repository. Gitlab then enforces Gitlab Login on the website, so you can only see the content if you are logged into Gitlab (and have been given access to the repository).</p><p>This is a very cool way to host private static sites freely (vs, for example, self-hosting + HTTP Basic Auth).</p><h2 id="moving-from-github-actions-to-gitlab-ci-cd-pipelines&ndash;plus-running-docker-containers-in-ci-cd-scripts">Moving from Github Actions to Gitlab CI/CD Pipelines (+ running Docker containers in CI/CD scripts)</h2><p>It's ridiculously hard to Google for the right way to run a dockerized tool in CI/CD environments.</p><p>Github Actions makes this a nobrainer because their images (example: <code>ubuntu-latest</code>) have <code>docker</code> clients and servers baked in already. So you just write your command (say <code>docker run hello-world</code>) directly into your YAML file and you are done.</p><p>Gitlab CI/CD does not have this. They expect you to search + use images from Dockerhub / Gitlab Container Registry. To make matters worse, it isn't enough to use the official Docker in Docker image (which is <code>docker:latest</code> btw). Using this image only gives you the <code>docker</code> client. You still need to run the <code>docker</code> server separately. If you don't, your pipeline will fail with the following error:</p><pre><code class="lang-text">docker: error during connect: Post &quot;http://docker:2375/v1.24/containers/create&quot;: dial tcp: lookup docker on 169.254.169.254:53: no such host.
</code></pre><p>To run the server, you need to understand the <a href='https://docs.gitlab.com/ee/ci/services/'>Services</a> concept of Gitlab CI/CD. In short, this is a way to run services that your main job might need to access when it runs. You can use it, for example, to run database instances that your test job would connect to. In our case, we need a docker daemon service, which is provided by the <code>docker:dind</code> image.</p><p>Once you have this, then your entire pipeline will finally run. It took me a frustratingly long time to figure it all out. Here is what my final <code>.gitlab-ci.yml</code> file looks like:</p><pre><code class="lang-yaml">workflow:
  rules:
    - if: $CI&#95;COMMIT&#95;BRANCH

before&#95;script:
  - mkdir -p .neuron/output &amp;&amp; touch .neuron/output/.nojekyll

pages:
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker run -v $PWD/content:/notes sridca/neuron neuron gen --pretty-urls
    - cp -R content/.neuron/output public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI&#95;COMMIT&#95;BRANCH == &quot;master&quot;
</code></pre><p>The <code>pages</code> job-name is special. Gitlab understands that it is meant for hosting, and expects HTML / assets in a top-level directory called <code>public</code>.</p><p>I hope this helps someone else waste less time.</p><p></div> </div> </div></p></div><div id="post-last-updated"><p><i>Last Updated: 2022-08-23T10:19:00Z</i></p></div><hr /><div id="post-parents"><div id="post-links"><h1>Parents</h1><ul><li><span>2024-03-27</span><span> - </span><a href="/tools.html">Tools</a></li></ul></div></div><hr /><div id="post-tags"><h1 class="links-header">Tags</h1><div class="flex"><div class="inline-flex"><a href="/tags/tools.html">tools</a><span class="mx-2">|</span></div><div class="inline-flex"><a href="/tags/cicd.html">cicd</a><span class="mx-2"></span></div></div></div><nav class="bottom-0 right-0 float-right mb-6" id="post-nav"><a class="px-2" href="/index.html">Archive</a><a class="px-2" href="https://github.com/vedang/vedang.me/blob/master/components/content/resources/content/tools/gitlab-private-pages-docker.md" target="_blank">Discuss this post</a></nav><nav class="bottom-0 left-0 float-left mb-6" id="copyright-nav"><p>Except where otherwise noted, content on this site is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International license</a>.</p><p>Built with ❤️, using <a href="https://www.gnu.org/software/emacs/">Emacs</a>, <a href="https://orgmode.org/">Org-mode</a>, <a href="https://clojure.org/index">Clojure</a>, <a href="https://babashka.org/">Babashka</a>, <a href="https://tailwindcss.com/">TailwindCSS</a>, <a href="https://prismjs.com/">PrismJS</a></p></nav></div></body></html>